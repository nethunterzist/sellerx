name: Deploy Backend

on:
  push:
    branches: [main]
    paths: ['sellerx-backend/**']
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: ./sellerx-backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Server with Rollback
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 157.180.78.53
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            CONTAINER_NAME="sellerx-backend"
            IMAGE_REPO="ghcr.io/nethunterzist/sellerx/backend"
            NEW_IMAGE="${IMAGE_REPO}:latest"
            ROLLBACK_IMAGE="${IMAGE_REPO}:rollback"
            HEALTH_ENDPOINT="http://localhost:8080/actuator/health"
            MAX_HEALTH_RETRIES=15
            HEALTH_RETRY_DELAY=10

            echo "=== Starting deployment with rollback support ==="

            # Step 0: Login to GHCR (for private repo)
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u nethunterzist --password-stdin

            # Step 1: Save current running image as rollback
            if docker inspect $CONTAINER_NAME >/dev/null 2>&1; then
              CURRENT_IMAGE=$(docker inspect --format='{{.Config.Image}}' $CONTAINER_NAME)
              echo "Tagging current image as rollback: $CURRENT_IMAGE"
              docker tag $CURRENT_IMAGE $ROLLBACK_IMAGE 2>/dev/null || true
            fi

            # Step 2: Pull new image
            echo "Pulling new image: $NEW_IMAGE"
            docker pull $NEW_IMAGE

            # Step 3: Stop and remove old container
            echo "Stopping old container..."
            docker stop $CONTAINER_NAME 2>/dev/null || true
            docker rm $CONTAINER_NAME 2>/dev/null || true

            # Step 4: Run new container
            echo "Starting new container..."
            docker run -d \
              --name $CONTAINER_NAME \
              --network coolify \
              --restart unless-stopped \
              -e DB_HOST=uws408w88ko044c84gwgkw04 \
              -e DB_PORT=5432 \
              -e DB_NAME=sellerx_db \
              -e DB_USERNAME=postgres \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
              -e ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }} \
              -e SERVER_PORT=8080 \
              -e SPRING_PROFILES_ACTIVE=production \
              -e SPRING_FLYWAY_VALIDATE_ON_MIGRATE=false \
              -e CORS_ALLOWED_ORIGINS=https://sellerx.157.180.78.53.sslip.io \
              -e WEBHOOK_BASE_URL=https://uwgss4kkocg4kks8880kwwwo.157.180.78.53.sslip.io \
              -e WEBHOOK_API_KEY=webhook-api-key-placeholder \
              -e WEBHOOK_SIGNATURE_SECRET=webhook-signature-secret-placeholder \
              -e IYZICO_CALLBACK_URL=https://sellerx.157.180.78.53.sslip.io/api/payment/callback \
              -e FRONTEND_URL=https://sellerx.157.180.78.53.sslip.io \
              -e PARASUT_REDIRECT_URI=https://sellerx.157.180.78.53.sslip.io/api/parasut/callback \
              -l traefik.enable=true \
              -l 'traefik.http.routers.sellerx-backend.rule=Host(`uwgss4kkocg4kks8880kwwwo.157.180.78.53.sslip.io`)' \
              -l traefik.http.routers.sellerx-backend.entrypoints=https \
              -l traefik.http.routers.sellerx-backend.tls=true \
              -l traefik.http.services.sellerx-backend.loadbalancer.server.port=8080 \
              $NEW_IMAGE

            # Step 5: Health check with retries
            echo "Waiting for application to start..."
            sleep 60

            HEALTH_OK=false
            for i in $(seq 1 $MAX_HEALTH_RETRIES); do
              echo "Health check attempt $i/$MAX_HEALTH_RETRIES..."

              # Check container is running
              if ! docker ps | grep -q $CONTAINER_NAME; then
                echo "Container not running! Checking logs..."
                docker logs $CONTAINER_NAME --tail 50
                break
              fi

              # Check if Spring Boot has started by looking for startup message in logs
              if docker logs $CONTAINER_NAME 2>&1 | grep -q "Started StoreApplication"; then
                echo "Health check passed! Spring Boot application started."
                HEALTH_OK=true
                break
              fi

              echo "Application not ready yet, waiting..."
              sleep $HEALTH_RETRY_DELAY
            done

            # Step 6: Rollback if health check failed
            if [ "$HEALTH_OK" = false ]; then
              echo "=== HEALTH CHECK FAILED - INITIATING ROLLBACK ==="

              # Show container logs for debugging
              echo "Container logs:"
              docker logs $CONTAINER_NAME --tail 100

              # Check if we have a rollback image
              if docker images | grep -q "$ROLLBACK_IMAGE"; then
                echo "Rolling back to previous version..."
                docker stop $CONTAINER_NAME 2>/dev/null || true
                docker rm $CONTAINER_NAME 2>/dev/null || true

                # Run rollback container
                docker run -d \
                  --name $CONTAINER_NAME \
                  --network coolify \
                  --restart unless-stopped \
                  -e DB_HOST=uws408w88ko044c84gwgkw04 \
                  -e DB_PORT=5432 \
                  -e DB_NAME=sellerx_db \
                  -e DB_USERNAME=postgres \
                  -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
                  -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
                  -e ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }} \
                  -e SERVER_PORT=8080 \
                  -e SPRING_PROFILES_ACTIVE=production \
                  -e SPRING_FLYWAY_VALIDATE_ON_MIGRATE=false \
                  -e CORS_ALLOWED_ORIGINS=https://sellerx.157.180.78.53.sslip.io \
                  -e WEBHOOK_BASE_URL=https://uwgss4kkocg4kks8880kwwwo.157.180.78.53.sslip.io \
                  -e WEBHOOK_API_KEY=webhook-api-key-placeholder \
                  -e WEBHOOK_SIGNATURE_SECRET=webhook-signature-secret-placeholder \
                  -e IYZICO_CALLBACK_URL=https://sellerx.157.180.78.53.sslip.io/api/payment/callback \
                  -e FRONTEND_URL=https://sellerx.157.180.78.53.sslip.io \
                  -e PARASUT_REDIRECT_URI=https://sellerx.157.180.78.53.sslip.io/api/parasut/callback \
                  -l traefik.enable=true \
                  -l 'traefik.http.routers.sellerx-backend.rule=Host(`uwgss4kkocg4kks8880kwwwo.157.180.78.53.sslip.io`)' \
                  -l traefik.http.routers.sellerx-backend.entrypoints=https \
                  -l traefik.http.routers.sellerx-backend.tls=true \
                  -l traefik.http.services.sellerx-backend.loadbalancer.server.port=8080 \
                  $ROLLBACK_IMAGE

                echo "Rolled back to previous version. Waiting for startup..."
                sleep 20

                if docker ps | grep -q $CONTAINER_NAME; then
                  echo "Rollback container is running."
                else
                  echo "CRITICAL: Rollback container also failed!"
                  exit 1
                fi
              else
                echo "No rollback image available!"
                exit 1
              fi

              # Exit with failure to mark deployment as failed
              exit 1
            fi

            echo "=== Deployment successful! ==="
            docker logs $CONTAINER_NAME --tail 20

            # Cleanup old images (keep rollback)
            docker image prune -f
